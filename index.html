<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Kontrol IoT - ESP32-CAM</title>
    <!-- 1. Load Tailwind CSS (untuk styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Supabase-JS (untuk koneksi) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Sembunyikan panah input angka */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-5">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">üõ∞Ô∏è Panel Kontrol IoT</h1>

        <!-- BAGIAN KONTROL -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            
            <!-- Panel Kontrol Kustom -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Kontrol Manual</h2>
                
                <!-- Kontrol Alarm -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bunyikan Alarm</label>
                    <div class="flex gap-2">
                        <input type="number" id="alarmCount" placeholder="Jumlah (cth: 2)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <input type="number" id="alarmDuration" placeholder="Durasi (ms)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <input type="number" id="alarmDelay" placeholder="Delay (ms)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                    <button onclick="sendAlarm()" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Kirim Perintah Alarm</button>
                </div>
                
                <!-- Kontrol LCD -->
                <div class="mb-4">
                    <label for="lcdText" class="block text-sm font-medium text-gray-700">Tulis ke LCD</label>
                    <input type="text" id="lcdText" placeholder="Tulis sesuatu... (max 32 char)" maxlength="32" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <button onclick="sendLCDText()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Kirim Teks LCD</button>
                </div>

                <!-- Kontrol Jarak Trigger -->
                <div class="mb-4">
                    <label for="triggerDistance" class="block text-sm font-medium text-gray-700">Ganti Jarak Trigger (cm)</label>
                    <input type="number" id="triggerDistance" placeholder="Jarak baru (cth: 50)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <button onclick="sendTriggerDistance()" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Set Jarak Baru</button>
                </div>
            </div>

            <!-- Panel Kontrol Cepat -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Kontrol Cepat</h2>
                <div class="flex flex-col gap-4">
                    <button onclick="requestFoto()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md transition duration-200 text-lg">üì∏ Ambil Foto Sekarang</button>
                    <button onclick="sendAlarm(1, 1000, 0)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-md transition duration-200 text-lg">üîî Bunyikan Alarm (1x 1dtk)</button>
                    <button onclick="sendLCDText('Halo dari Web!')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md transition duration-200 text-lg">üìü Tes Tulis LCD</button>
                </div>
                <div id="statusMessage" class="mt-4 text-center text-sm text-green-600 font-medium"></div>
            </div>
        </div>

        <!-- BAGIAN LOG -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Log Deteksi (Realtime)</h2>
            <div id="log-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Log akan muncul di sini -->
                <div id="loadingLogs" class="text-center col-span-full text-gray-500">Memuat log...</div>
            </div>
        </div>
    </div>

    <!-- 3. JAVASCRIPT APLIKASI -->
    <script>
        // =======================================================
        // KONEKSI SUPABASE
        // =======================================================
        // Ganti dengan URL dan Kunci ANON (Public) Supabase-mu
        // Ini adalah kunci yang sama dengan yang ada di ESP32-mu
        const SUPABASE_URL = "https://teennmkmzhhltjxujccz.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlZW5ubWttemhobHRqeHVqY2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzk3ODUsImV4cCI6MjA3ODY1NTc4NX0.yXIbih2oMiw94Q-2gG-6Yh4ZGidHpPIpeuZDAwbH_DM";

        // *** PERBAIKAN: ***
        // 'supabase' (objek global) digunakan untuk membuat 'client' (instance klien baru)
        // Sebelumnya: const supabase = supabase.createClient(...) -> Error
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const logContainer = document.getElementById('log-container');
        const statusMessage = document.getElementById('statusMessage');

        // =======================================================
        // FUNGSI KIRIM PERINTAH
        // =======================================================

        async function sendCommand(tipe, payload) {
            try {
                // *** PERBAIKAN: *** Menggunakan 'client'
                const { data, error } = await client
                    .from('perintah_device')
                    .insert({ 
                        tipe_perintah: tipe, 
                        payload: payload 
                    });
                
                if (error) throw error;

                console.log('Perintah terkirim:', data);
                statusMessage.textContent = `Perintah '${tipe}' berhasil terkirim!`;
                setTimeout(() => statusMessage.textContent = '', 3000);
            } catch (error) {
                console.error('Error kirim perintah:', error);
                statusMessage.textContent = `Error: ${error.message}`;
            }
        }

        // --- Fungsi Tombol Kontrol ---

        function sendAlarm(count, duration, delay) {
            const c = count || document.getElementById('alarmCount').valueAsNumber;
            const d = duration || document.getElementById('alarmDuration').valueAsNumber;
            const del = delay !== undefined ? delay : document.getElementById('alarmDelay').valueAsNumber;

            if (!c || !d) {
                alert('Harap isi jumlah dan durasi alarm.');
                return;
            }
            sendCommand('alarm', { count: c, duration: d, delay: del || 0 });
        }

        function sendLCDText(text) {
            const t = text || document.getElementById('lcdText').value;
            if (!t) {
                alert('Harap isi teks LCD.');
                return;
            }
            sendCommand('lcd', { teks: t });
        }

        function sendTriggerDistance() {
            const jarak = document.getElementById('triggerDistance').valueAsNumber;
            if (!jarak || jarak <= 0) {
                alert('Harap isi jarak trigger yang valid.');
                return;
            }
            sendCommand('jarak', { jarak: jarak });
        }

        function requestFoto() {
            sendCommand('foto', {});
        }

        // =======================================================
        // FUNGSI TAMPILKAN LOG (REALTIME)
        // =======================================================

        // Fungsi untuk merender 1 log ke HTML
        function renderLog(log) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 border border-gray-200 rounded-lg shadow-sm overflow-hidden';
            
            const img = document.createElement('img');
            img.src = log.url_foto;
            img.alt = 'Foto Deteksi';
            img.className = 'w-full h-48 object-cover';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'p-4';
            
            const textP = document.createElement('p');
            textP.className = 'text-sm font-medium text-gray-900';
            textP.textContent = log.pesan || 'Objek terdeteksi';
            
            const dateP = document.createElement('p');
            dateP.className = 'text-xs text-gray-500 mt-1';
            dateP.textContent = new Date(log.created_at).toLocaleString('id-ID');
            
            textDiv.appendChild(textP);
            textDiv.appendChild(dateP);
            div.appendChild(img);
            div.appendChild(textDiv);
            
            // Tambahkan ke paling depan
            logContainer.prepend(div);
        }

        // 1. Ambil data log yang sudah ada
        async function fetchLogs() {
            // *** PERBAIKAN: *** Menggunakan 'client'
            const { data, error } = await client
                .from('log_deteksi')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(20);
            
            document.getElementById('loadingLogs').style.display = 'none';

            if (error) {
                console.error('Error fetching logs:', error);
                return;
            }
            
            data.forEach(renderLog);
        }

        // 2. Dengarkan data log BARU secara realtime
        function subscribeToLogs() {
            // *** PERBAIKAN: *** Menggunakan 'client'
            client
                .channel('log_deteksi_channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'log_deteksi' }, 
                    (payload) => {
                        console.log('Perubahan baru diterima!', payload.new);
                        // Ada log baru, render ke halaman!
                        renderLog(payload.new);
                        alert('DETEKSI BARU! Ada foto baru masuk.');
                    })
                .subscribe();
        }

        // --- JALANKAN SAAT HALAMAN DIBUKA ---
        fetchLogs();
        subscribeToLogs();

    </script>
</body>
</html>
